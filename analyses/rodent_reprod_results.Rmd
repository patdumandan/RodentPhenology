---
title: "Rodent Reproduction"
---  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(portalr)
library(ggplot2)
library(lubridate)
library(reshape2)
library(splines)
library(rstan)
library(mgcv)
library(dotwhisker)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

portal_reprod=read.csv("https://raw.githubusercontent.com/patdumandan/ReproPhenology/main/ReproData/reprod_full_dat.csv")
```

### Results   

#### I. Reproductive phenology under different biotic conditions 

```{r include=F, warning=F, message=F}
pb_plot=portal_reprod%>%filter(species=="PB")
PB_male_con=pb_plot%>%filter(treatment=="control", sex=="male")
PB_male_ex=pb_plot%>%filter(treatment=="exclosure", sex=="male")
PB_female_con=pb_plot%>%filter(treatment=="control", sex=="female")
PB_female_ex=pb_plot%>%filter(treatment=="exclosure", sex=="female")
```  

```{r message=FALSE, echo=FALSE, warning=FALSE, fig.cap= "Fig. 1. Reproductive phenology of PB males and females in control and exclosure plots"}
ggplot(pb_plot, aes(y=proportion, x=month, col=treatment)) +
  geom_point() +
  ylab("P(breeding)")+
  stat_smooth(method = 'gam', formula = y ~ s(x))+
  ggtitle("Bailey's pocket mouse")+ facet_wrap(~sex)+
  scale_x_discrete(name="month", limits=c("Jan", "Feb", "Mar", "Apr","May", "Jun",
                                          "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"))+
  theme(axis.text.x= element_text(angle = 90, vjust=0.5, hjust=1),
        panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
```  


```{r include=F, warning=F, message=F}
pp_plot=portal_reprod%>%filter(species=="PP")
PP_male_con=pp_plot%>%filter(treatment=="control", sex=="male")
PP_male_ex=pp_plot%>%filter(treatment=="exclosure", sex=="male")
PP_female_con=pp_plot%>%filter(treatment=="control", sex=="female")
PP_female_ex=pp_plot%>%filter(treatment=="exclosure", sex=="female")
```   

```{r message=FALSE, echo=FALSE, warning=FALSE, fig.cap= "Fig. 2. Reproductive phenology of PP males and females in control and exclosure plots"}
ggplot(pp_plot, aes(y=proportion, x=month, col=treatment)) +
  geom_point() +
  ylab("P(breeding)")+
  stat_smooth(method = 'gam', formula = y ~ s(x))+
  ggtitle("desert pocket mouse")+ facet_wrap(~sex)+
  scale_x_discrete(name="month", limits=c("Jan", "Feb", "Mar", "Apr","May", "Jun",
                                          "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"))+
  theme(axis.text.x= element_text(angle = 90, vjust=0.5, hjust=1),
        panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
```     


#### II. Effects of different biotic and abiotic factors in the P(breeding) of rodents   

A. *Chaetodipus baileyi* (Bailey's pocket mouse)  

```{r echo=F, warning=F, message=FALSE}

pbm_con1=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool, data=PB_male_con, method = 'REML', weights = abundance, family = binomial)
pbm_ex1=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool, data=PB_male_ex, method = 'REML', weights = abundance, family = binomial)

pbf_con1=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool, data=PB_female_con, method = 'REML', weights = abundance, family = binomial)
pbf_ex1=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool, data=PB_female_ex, method = 'REML', weights = abundance, family = binomial)

```  
```{r echo=F, warning=F, message=FALSE}

pbm_con2=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs, data=PB_male_con, method = 'REML', weights = abundance, family = binomial)
pbm_ex2=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs, data=PB_male_ex, method = 'REML', weights = abundance, family = binomial)

pbf_con2=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs, data=PB_female_con, method = 'REML', weights = abundance, family = binomial)
pbf_ex2=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs, data=PB_female_ex, method = 'REML', weights = abundance, family = binomial)
```  


```{r echo=F, warning=F, message=FALSE}

pbm_con3=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs+pps+dipos, data=PB_male_con, method = 'REML', weights = abundance, family = binomial)
pbm_ex3=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs+pps+dipos, data=PB_male_ex, method = 'REML', weights = abundance, family = binomial)

pbf_con3=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs+pps+dipos, data=PB_female_con, method = 'REML', weights = abundance, family = binomial)
pbf_ex3=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs+pps+dipos, data=PB_female_ex, method = 'REML', weights = abundance, family = binomial)
```  

```{r echo=F, fig.show="hold",out.width="50%", fig.cap="Fig. 3. Association between abiotic factors and the P(breeding) of PB males and females in control and exclosure plots"}
dwplot(list(pbm_con1, pbm_ex1))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
    labels = c("Exclosure","Control"))+ggtitle("PB males (abiotic only)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

dwplot(list(pbf_con1, pbf_ex1))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
    labels = c("Exclosure","Control"))+ggtitle("PB females (abiotic only)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

dwplot(list(pbm_con2, pbm_ex2))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
    labels = c("Exclosure","Control"))+ggtitle("PB males (abiotic+ intraspecific competition)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

dwplot(list(pbf_con2, pbf_ex2))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
    labels = c("Exclosure","Control"))+ggtitle("PB females (abiotic+ intraspecific competition)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

dwplot(list(pbm_con3, pbm_ex3))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
    labels = c("Exclosure","Control"))+ggtitle("PB males (abiotic+intra+interspecific competition)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

dwplot(list(pbf_con3, pbf_ex3))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
    labels = c("Exclosure","Control"))+ggtitle("PB females (abiotic+intra+interspecific competition)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

```  

B. *Chaetodipus penicillatus* (desert pocket mouse)  

```{r echo=F, warning=F, message=FALSE}

ppm_con1=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool, data=PP_male_con, method = 'REML', weights = abundance, family = binomial)
ppm_ex1=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool, data=PP_male_ex, method = 'REML', weights = abundance, family = binomial)

ppf_con1=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool, data=PP_female_con, method = 'REML', weights = abundance, family = binomial)
ppf_ex1=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool, data=PP_female_ex, method = 'REML', weights = abundance, family = binomial)

```  

```{r echo=F, warning=F, message=FALSE}

ppm_con2=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pps, data=PP_male_con, method = 'REML', weights = abundance, family = binomial)
ppm_ex2=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pps, data=PP_male_ex, method = 'REML', weights = abundance, family = binomial)

ppf_con2=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pps, data=PP_female_con, method = 'REML', weights = abundance, family = binomial)
ppf_ex2=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pps, data=PP_female_ex, method = 'REML', weights = abundance, family = binomial)
```  

```{r echo=F, warning=F, message=FALSE}

ppm_con3=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs+pps+dipos, data=PP_male_con, method = 'REML', weights = abundance, family = binomial)
ppm_ex3=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs+pps+dipos, data=PP_male_ex, method = 'REML', weights = abundance, family = binomial)

ppf_con3=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs+pps+dipos, data=PP_female_con, method = 'REML', weights = abundance, family = binomial)
ppf_ex3=mgcv::gam(proportion~s(month,bs="cc")+s(year)+ndvis+ndvis_lag+temps_mean+temps_lag_mean+ppts_warm+ppts_lag_warm+ppts_cool+ppts_lag_cool+ pbs+pps+dipos, data=PP_female_ex, method = 'REML', weights = abundance, family = binomial)
```  

```{r echo=F, fig.show="hold",out.width="50%", fig.cap="Fig. 4. Association between abiotic and biotic factors and the P(breeding) of PP males and females in control and exclosure plots"}
dwplot(list(ppm_con1, ppm_ex1))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
                   labels = c("Exclosure","Control"))+ggtitle("PP males (abiotic only)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

dwplot(list(ppf_con1, ppf_ex1))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
                   labels = c("Exclosure","Control"))+ggtitle("PP females (abiotic only)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

dwplot(list(ppm_con2, ppm_ex2))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
                   labels = c("Exclosure","Control"))+ggtitle("PP males (abiotic+intraspecific competition)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

dwplot(list(ppf_con2, ppf_ex2))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
                   labels = c("Exclosure","Control"))+ggtitle("PP females (abiotic+intraspecific competition)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")
dwplot(list(ppm_con3, ppm_ex3))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
                   labels = c("Exclosure","Control"))+ggtitle("PP males (abiotic+intra+interspecific competition)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

dwplot(list(ppf_con3, ppf_ex3))+
  scale_color_grey(start = .3,end = .7,name = "Treatment",
                   labels = c("Exclosure","Control"))+ggtitle("PP females(abiotic+intra+interspecific competition)")+
  theme_classic()+geom_vline(xintercept=0, linetype="dotted")

```  


```{r echo=F, include=F}
tmpf <- tempfile()
download.file("https://gist.github.com/gavinsimpson/e73f011fdaaab4bb5a30/raw/82118ee30c9ef1254795d2ec6d356a664cc138ab/Deriv.R",tmpf)
source(tmpf)
```  

```{r include=F}
want=seq(1, nrow(PB_male_con), length.out = 200)
pdat1=with(PB_male_con, data.frame(year=year[want], month=month[want], ndvis=ndvis[want], 
                                   ppts_warm=ppts_warm[want], ndvis_lag=ndvis_lag[want],
                                   temps_mean=temps_mean[want], temps_lag_mean=temps_lag_mean[want],
                                   ppts_lag_warm=ppts_lag_warm[want], ppts_cool=ppts_cool[want],
                                   ppts_lag_cool=ppts_lag_cool[want],dipos=dipos[want],
                                   pbs=bmass_PB[want],pps= bmass_PP[want]))
p1=predict(pbm_con3, newdata=pdat1, type="terms", se.fit = TRUE)
pdat1=transform(pdat1, p1=p1$fit[,1], se1=p1$se.fit[,1]) 
df.res=df.residual(pbm_con3)
crit.t=qt(0.025, df.res, lower.tail = F)
pdat1=transform(pdat1, upper=p1+(crit.t*se1), lower=p1-(crit.t*se1))
p1.d <- Deriv(pbm_con1)
Term="month"
p1.dci <- confint(p1.d, term = Term)
p1.dsig <- signifD(pdat1$p1, d = p1.d[[Term]]$deriv,
                   +p1.dci[[Term]]$upper, p1.dci[[Term]]$lower)
plot.Deriv(p1.d, sizer=T, term=Term, xaxt="n")
axis(1, at=1:12, labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"))
abline(v=3.8, type="l", lty=2)
ylim <- with(pdat1, range(upper, lower, p1))
plot(p1 ~ month, data = pdat1, type = "n", ylim = ylim)
lines(p1 ~ month, data = pdat1)
lines(upper ~ month, data = pdat1, lty = "dashed")
lines(lower ~ month, data = pdat1, lty = "dashed")
lines(unlist(p1.dsig$incr) ~ month, data = pdat1, col = "blue", lwd = 3)
lines(unlist(p1.dsig$decr) ~ month, data = pdat1, col = "red", lwd = 3)
```  

### Key Findings  

* In general, PPs have a more pronounced reproductive timing than PBs (because of seasonal dormancy, PPs are generally inactive during winter). Does it have anything to do with size too?   
* Male PBs don't necessarily have a "peak" period of reproduction but females do, around late spring. Female PBs in exclosures are more likely to have a second "peak" in reproductive activity around Sept-October than those in control plots. Is this indicative of adults of this species being optimistic and trying again in the absence of dominant competitors or is this a result of young born earlier in the year being reproductive by this time of the year?  
* Male and female PPs in both control and exclosure plots are more likely to be reproductive when there is an abundance of vegetation (late spring), which may suggest that the main reproductive cues for both sexes are those linked to food availability  
*Note: only drawing inferences from most complex models (abiotic+intra+inter; i.e., Fig. 4 and 7) because they tend to have the highest deviance explained)*  
* Male PBs are more responsive to biotic factors than females in both exclosure and control plots. P(breeding) of male PBs in control and exclosure plots are negatively associated with PB biomass and positively associated with PP biomass. does this mean that with increased biomass of similar species (which may be linked to increased population density), males are less likely to be reproductive (because of competition with access to females)? as for the positive association with PPs, does it mean that PB males don't really care if there are more PPs because they can exclude them anyway? or something?  
* PB females are more responsive to abiotic factors in both control and exclosure plots, but the triggers differ. P(breeding) of females in exclosures is positively associated with NDVI (lag 1), amount of warm precipitation (lag 0), and negatively associated with  NDVI (lag 0). P(breeding) of females in control plots is positively associated with amount of warm precipitation (lag 0), and amount of cool precipitation (lag 1). Does a negative association with NDVI (lag 0)and positive association with NDVI (lag 1) mean that if there is more green vegetation the month before, PB females are likely to be reproductive in the current month but are less likely to be reproductive the same month as when NDVI is high? Is it because if they were reproductive the month before, they will probably not be reproductive the month after (gestation period)?  
* PB females in both control and exclosure are more likely to be reproductive if the cumulative amount of rain in the last 3 months when there are more warm days (i.e., summer/late spring) is high (e.g. , P(breeding) in May is positively linked to the total amount of rain during warm days from March-May). does this have anything to do with how soil moisture can facilitate seed germination? or how rain would make it easier for rodents to dig through the soil to access seeds because rain moistens it? also, in this case, does it mean that if by May the amount of rain that fell during warm days is high, they will be reproductive on that same month because if seeds germinate quickly in summer (2 weeks or so?), they'll be certain that in the next month, there will be food available for the offsprings?   
* PB females in control plots are more likely to be in reproductive state if the month prior has a high amount of accumulated rain that fell during "cool days" (i.e., P(breeding) in January is positively linked to the amount of "cool rain" that fell from Oct-Dec?) is this about the same time when winter plants germinate? why are they doing this (using cool rain as a trigger) in the control plots? does it have to do with how they might prefer winter plants as food sources in the presence of a dominant competitor?  
* PP males seem to pretty much just depend on internal cues (perhaps) rather than external cues on when they should be reproductive because despite having a distinct peak in reproduction, there is no predictor that seems to be strongly associated with their P(breeding). in exclosures, their P(breeding) is negatively associated with warm precip (lag 1), which means that if there was a lot of "warm rain" until the month before, they are less likely to be reproductive (?) why?  
* P(breeding) of PP females in both controls and exclosure are negatively associated with PB biomass, and positively linked to mean temperature, amount of warm precip, and PP biomass. do these similarities in the relationship of P(breeding) and these factors have to do with the fact that they undergo seasonal dormancy? so whichever biotic context they're in, it seems like they'll be reproductive in the same month when temp is high (potentially temperature is a direct cue for like their physiological functions?), and when the amount of "warm rain" that fell up until that month is high (probably suggests that they use rain more as a direct cue again for making the soil moist and easy to dig?). high biomass of similar species (high intraspecific competition) is positively associated with P(breeding) while high biomass of much bigger competitors (thus high interspecific competition) is negatively associated with their P(breeding). does this mean that breeding females are not really bothered by sharing resources with similar species, but are bothered by PBs that can exclude them?  
* what's the best way for me to plot the periods of significant change in P(breeding)? separate plot for each species and treatment and then have a shaded area for periods of significant increase/decrease? not a big fan of the current plot I made for this report.  